#!/bin/bash

# Dictation toggle with automatic microphone switching to headphones
# On first toggle: saves current mic state, switches to headphone mic, starts dictation
# On second toggle: stops dictation, restores previous mic state

PIDFILE="/tmp/deepgram-dictation.pid"
STATEFILE="/tmp/dictation-mic-state"

CARD="bluez_card.AC_80_0A_5D_C1_97"
A2DP_PROFILE="a2dp-sink"
HSP_PROFILE="headset-head-unit-msbc"
YETI_SOURCE="alsa_input.usb-Blue_Microphones_Yeti_Stereo_Microphone_REV8-00.analog-stereo"

is_dictation_running() {
    [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null
}

get_pid() {
    [ -f "$PIDFILE" ] && cat "$PIDFILE"
}

save_mic_state() {
    local current_source=$(pactl get-default-source 2>/dev/null)
    local current_profile=$(pactl list cards | grep -A20 "$CARD" | grep "Active Profile:" | cut -d: -f2 | tr -d ' ')
    # Use separate lines for robustness (no = parsing issues)
    echo "$current_source" > "$STATEFILE"
    echo "$current_profile" >> "$STATEFILE"
}

restore_mic_state() {
    if [ ! -f "$STATEFILE" ]; then
        return 1
    fi

    # Read state file line by line (more robust than source)
    local saved_source=$(sed -n '1p' "$STATEFILE")
    local saved_profile=$(sed -n '2p' "$STATEFILE")

    # Restore bluetooth profile if it was saved
    if [ -n "$saved_profile" ]; then
        pactl set-card-profile "$CARD" "$saved_profile" 2>/dev/null
        sleep 0.3
    fi

    # Restore default source
    if [ -n "$saved_source" ]; then
        pactl set-default-source "$saved_source" 2>/dev/null
    fi

    rm -f "$STATEFILE"
}

switch_to_headphone_mic() {
    # Switch bluetooth to HSP profile (enables mic)
    pactl set-card-profile "$CARD" "$HSP_PROFILE" 2>/dev/null
    sleep 0.5

    # Set headphone as default source
    headphone_source=$(pactl list sources short | grep "bluez.*input" | cut -f2)
    if [ -n "$headphone_source" ]; then
        pactl set-default-source "$headphone_source"
    fi
}

if is_dictation_running; then
    # Stop dictation and restore mic state
    pid=$(get_pid)
    kill "$pid" 2>/dev/null

    # Wait for process to actually die (up to 2 seconds)
    for i in {1..20}; do
        kill -0 "$pid" 2>/dev/null || break
        sleep 0.1
    done

    restore_mic_state
    notify-send "Dictation" "Stopped - mic restored" -t 1500
else
    # Kill any orphaned processes
    pkill -f "python.*deepgram-dictation" 2>/dev/null
    rm -f "$PIDFILE"

    # Save current mic state and switch to headphone
    save_mic_state
    switch_to_headphone_mic

    # Start dictation
    setsid ~/scripts/deepgram-dictation 2>/tmp/deepgram-dictation.log &
    notify-send "Dictation" "Listening via headphone mic..." -t 1500
fi
