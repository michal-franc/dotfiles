#!/bin/bash

# Initialize mise for correct Python path
eval "$(/home/mfranc/.local/bin/mise activate bash)"

NERD_DICTATION="/home/mfranc/Work/nerd-dictation/nerd-dictation"
MODEL_DIR="/home/mfranc/Work/nerd-dictation/model"

# Precondition checks
if [[ ! -x "$NERD_DICTATION" ]]; then
    notify-send -u critical "Dictation Error" "nerd-dictation not found or not executable:\n$NERD_DICTATION"
    exit 1
fi

if [[ ! -d "$MODEL_DIR" ]]; then
    notify-send -u critical "Dictation Error" "Model directory not found:\n$MODEL_DIR"
    exit 1
fi

if ! command -v xdotool &> /dev/null; then
    notify-send -u critical "Dictation Error" "xdotool not installed"
    exit 1
fi

if ! python3 -c "import vosk" &> /dev/null; then
    notify-send -u critical "Dictation Error" "Python vosk module not installed"
    exit 1
fi

# Toggle dictation
if pgrep -f "nerd-dictation begin" > /dev/null; then
    $NERD_DICTATION end
    notify-send "Dictation" "Stopped" -t 1000
else
    $NERD_DICTATION begin --vosk-model-dir="$MODEL_DIR" 2>/tmp/nerd-dictation-error.log &
    sleep 1
    if pgrep -f "nerd-dictation begin" > /dev/null; then
        notify-send "Dictation" "Listening..." -t 1000
    else
        notify-send -u critical "Dictation Error" "Failed to start. Check /tmp/nerd-dictation-error.log"
    fi
fi
