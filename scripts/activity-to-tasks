#!/bin/bash
# Review activity and create done tasks
# Uses rofi to select activities and convert them to done tasks

DATE="${1:-$(date +%Y-%m-%d)}"
SUMMARY_FILE="/tmp/activity-summary-$DATE.md"

# Generate summary if not exists
if [ ! -f "$SUMMARY_FILE" ]; then
    ~/scripts/activity-review "$DATE"
fi

# Parse activity into selectable items
ITEMS=""

# Add git commits
while IFS= read -r commit; do
    if [ -n "$commit" ]; then
        ITEMS+="[git] $commit\n"
    fi
done < <(grep -A 100 "## Git Commits" "$SUMMARY_FILE" | grep -E "^[a-f0-9]{7,}" | head -20)

# Add window activities (apps with significant time)
while IFS='|' read -r app time wins; do
    app=$(echo "$app" | xargs)
    time=$(echo "$time" | xargs)
    if [ -n "$app" ] && [ "$app" != "App" ]; then
        ITEMS+="[window] $app ($time): $wins\n"
    fi
done < <(grep -A 20 "## Window Activity" "$SUMMARY_FILE" | grep "^|" | grep -v "^| App" | grep -v "^|---" | sed 's/^| //' | sed 's/ |$//' | sed 's/ | /|/g')

# Add browser history items
while IFS= read -r line; do
    item=$(echo "$line" | sed 's/^- //')
    if [ -n "$item" ]; then
        ITEMS+="[browser] $item\n"
    fi
done < <(grep -A 50 "## Browser History" "$SUMMARY_FILE" | grep "^- " | head -20)

if [ -z "$ITEMS" ]; then
    notify-send "Activity Review" "No activities found for $DATE"
    exit 0
fi

# Let user select multiple items
SELECTED=$(echo -e "$ITEMS" | rofi -dmenu -p "Select done activities" -i -multi-select -lines 20)

if [ -z "$SELECTED" ]; then
    exit 0
fi

# Get project list for assignment
PROJECTS=$(task _unique project | grep -v '^$' | sort)
PROJECT_LIST="(No Project)\0icon\x1fdialog-cancel"
while IFS= read -r proj; do
    [ -n "$proj" ] && PROJECT_LIST+="\n$proj\0icon\x1ffolder"
done <<< "$PROJECTS"

# Process each selected item
echo "$SELECTED" | while IFS= read -r item; do
    [ -z "$item" ] && continue

    # Clean up the description
    DESC=$(echo "$item" | sed 's/^\[[^]]*\] //')

    # Truncate if too long
    DESC="${DESC:0:100}"

    # Let user edit and select project
    EDITED_DESC=$(rofi -dmenu -p "Task description:" -lines 0 -filter "$DESC")
    [ -z "$EDITED_DESC" ] && continue

    SELECTED_PROJECT=$(echo -e "$PROJECT_LIST" | rofi -dmenu -p "Project for: ${EDITED_DESC:0:30}..." -i -show-icons)
    [ -z "$SELECTED_PROJECT" ] && continue

    # Create and complete task
    if [ "$SELECTED_PROJECT" = "(No Project)" ]; then
        task add "$EDITED_DESC"
    else
        task add project:"$SELECTED_PROJECT" "$EDITED_DESC"
    fi

    # Mark as done
    NEW_UUID=$(task +LATEST uuids)
    task "$NEW_UUID" done

    echo "Created done task: $EDITED_DESC"
done

notify-send "Activity Review" "Done tasks created from activity log"
