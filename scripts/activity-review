#!/bin/bash
# End-of-day activity review script
# Aggregates: git commits, window activity, terminal history, browser history, claude sessions
# Outputs summary with potential todo items and sources

DATE="${1:-$(date +%Y-%m-%d)}"
OUTPUT_FILE="/tmp/activity-summary-$DATE.md"
LOG_DIR="$HOME/.local/share/activity"

# Git repos to check
GIT_DIRS=(
    "$HOME/Work"
    "$HOME/dotfiles"
)

echo "# Activity Summary for $DATE" > "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
echo "## Potential Done Tasks" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

#######################################
# Git Commits
#######################################
echo "### From Git Commits" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

for dir in "${GIT_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        find "$dir" -maxdepth 3 -name ".git" -type d 2>/dev/null | while read -r gitdir; do
            repo="${gitdir%/.git}"
            repo_name=$(basename "$repo")

            commits=$(git -C "$repo" log --format="%s" --since="$DATE 00:00" --until="$DATE 23:59" --author="$(git config user.name)" 2>/dev/null)

            if [ -n "$commits" ]; then
                echo "$commits" | while read -r msg; do
                    echo "- [git:$repo_name] $msg" >> "$OUTPUT_FILE"
                done
            fi
        done
    fi
done
echo "" >> "$OUTPUT_FILE"

#######################################
# Window Activity (aggregated)
#######################################
echo "### From Window Activity" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

WINDOW_LOG="$LOG_DIR/windows-$DATE.log"
if [ -f "$WINDOW_LOG" ]; then
    # Extract unique meaningful window titles as potential tasks
    awk -F'|' '{
        app = $2
        title = $3
        # Skip generic titles
        if (title !~ /^(New Tab|Untitled|$)/) {
            key = app "|" title
            if (!seen[key]++) {
                count[key]++
                apps[key] = app
                titles[key] = title
            } else {
                count[key]++
            }
        }
    }
    END {
        for (key in count) {
            if (count[key] >= 2) {  # Only show if focused multiple times
                print "- [window:" apps[key] "] " substr(titles[key], 1, 80)
            }
        }
    }' "$WINDOW_LOG" | sort -u | head -20 >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
else
    echo "_No window log found for $DATE_" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
fi

#######################################
# Terminal Commands (interesting ones)
#######################################
echo "### From Terminal" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Parse zsh history (format: : timestamp:0;command)
if [ -f "$HOME/.zsh_history" ]; then
    start_ts=$(date -d "$DATE 00:00" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M" "$DATE 00:00" +%s 2>/dev/null)
    end_ts=$(date -d "$DATE 23:59" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M" "$DATE 23:59" +%s 2>/dev/null)

    # Extract commands from today, filter out noise
    grep -a "^:" "$HOME/.zsh_history" | while IFS= read -r line; do
        ts=$(echo "$line" | sed 's/^: \([0-9]*\):.*/\1/')
        cmd=$(echo "$line" | sed 's/^: [0-9]*:[0-9]*;//')

        if [ "$ts" -ge "$start_ts" ] 2>/dev/null && [ "$ts" -le "$end_ts" ] 2>/dev/null; then
            echo "$cmd"
        fi
    done 2>/dev/null | \
    grep -vE '^(ls|cd|cat|less|head|tail|pwd|clear|exit|fg|bg|history|ll|la|\.\.|\.)$' | \
    grep -vE '^(git status|git diff|git log|task |rofi)' | \
    sort | uniq -c | sort -rn | head -15 | \
    awk '{$1=""; gsub(/^ +/, ""); print "- [terminal] " $0}' >> "$OUTPUT_FILE"
fi
echo "" >> "$OUTPUT_FILE"

#######################################
# Browser History
#######################################
echo "### From Browser" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

CHROME_HISTORY="$HOME/.config/google-chrome/Default/History"
if [ -f "$CHROME_HISTORY" ]; then
    # Copy to avoid locking issues
    cp "$CHROME_HISTORY" /tmp/chrome_history_copy.db 2>/dev/null

    # Query for today's visits
    sqlite3 /tmp/chrome_history_copy.db "
        SELECT DISTINCT
            CASE
                WHEN url LIKE '%github.com%' THEN 'GitHub: ' || substr(url, instr(url, 'github.com/') + 11, 50)
                WHEN url LIKE '%stackoverflow.com%' THEN 'SO: ' || substr(title, 1, 60)
                WHEN url LIKE '%google.com/search%' THEN 'Search: ' || replace(substr(url, instr(url, 'q=') + 2, 40), '+', ' ')
                WHEN url LIKE '%youtube.com/watch%' THEN 'YT: ' || substr(title, 1, 50)
                WHEN url LIKE '%docs.%' OR url LIKE '%documentation%' THEN 'Docs: ' || substr(title, 1, 50)
                ELSE substr(title, 1, 60)
            END as desc
        FROM urls
        WHERE date(datetime(last_visit_time/1000000-11644473600, 'unixepoch', 'localtime')) = '$DATE'
        AND url NOT LIKE '%google.com/gen_%'
        AND url NOT LIKE '%chrome://%'
        AND url NOT LIKE '%newtab%'
        AND title != ''
        ORDER BY last_visit_time DESC
        LIMIT 25
    " 2>/dev/null | while IFS='|' read -r desc; do
        echo "- [browser] $desc" >> "$OUTPUT_FILE"
    done

    rm -f /tmp/chrome_history_copy.db
else
    echo "_Chrome history not found_" >> "$OUTPUT_FILE"
fi
echo "" >> "$OUTPUT_FILE"

#######################################
# Claude Sessions
#######################################
echo "### From Claude Sessions" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

CLAUDE_HISTORY="$HOME/.claude/history.jsonl"
if [ -f "$CLAUDE_HISTORY" ]; then
    # Convert date to timestamp range (milliseconds)
    start_ts=$(($(date -d "$DATE 00:00" +%s) * 1000))
    end_ts=$(($(date -d "$DATE 23:59" +%s) * 1000))

    # Extract unique projects and first message from each session today
    jq -r --argjson start "$start_ts" --argjson end "$end_ts" '
        select(.timestamp >= $start and .timestamp <= $end) |
        "\(.project // "unknown")|\(.display)"
    ' "$CLAUDE_HISTORY" 2>/dev/null | \
    awk -F'|' '
    {
        proj = $1
        msg = $2
        # Get project basename
        n = split(proj, parts, "/")
        proj_name = parts[n]

        # Only keep first meaningful message per project
        if (length(msg) > 10 && !seen[proj]++) {
            gsub(/^ +| +$/, "", msg)
            print "- [claude:" proj_name "] " substr(msg, 1, 80)
        }
    }' | head -15 >> "$OUTPUT_FILE"
else
    echo "_Claude history not found_" >> "$OUTPUT_FILE"
fi
echo "" >> "$OUTPUT_FILE"

#######################################
# Output
#######################################
echo "Activity summary saved to: $OUTPUT_FILE"
echo ""
cat "$OUTPUT_FILE"
