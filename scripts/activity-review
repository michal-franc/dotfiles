#!/bin/bash
# End-of-day activity review script
# Aggregates: git commits, window activity, terminal history, browser history, claude sessions
# Outputs summary with potential todo items and sources
# Streams results section by section with timing

DATE="${1:-$(date +%Y-%m-%d)}"
OUTPUT_FILE="/tmp/activity-summary-$DATE.md"
LOG_DIR="$HOME/.local/share/activity"

# Git repos to check
GIT_DIRS=(
    "$HOME/Work"
    "$HOME/dotfiles"
)

# Helper to output and save simultaneously
out() {
    echo "$1" | tee -a "$OUTPUT_FILE"
}

# Clear output file
> "$OUTPUT_FILE"

out "# Activity Summary for $DATE"
out ""
out "## Potential Done Tasks"
out ""

#######################################
# Git Commits
#######################################
echo -n "Processing git commits..." >&2
start_time=$(($(date +%s%N)/1000000))

out "### From Git Commits"
out ""

found=0
for dir in "${GIT_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        while IFS= read -r gitdir; do
            repo="${gitdir%/.git}"
            repo_name=$(basename "$repo")

            commits=$(git -C "$repo" log --format="%s" --since="$DATE 00:00" --until="$DATE 23:59" --author="$(git config user.name)" 2>/dev/null)

            if [ -n "$commits" ]; then
                while IFS= read -r msg; do
                    out "- [git:$repo_name] $msg"
                    found=1
                done <<< "$commits"
            fi
        done < <(find "$dir" -maxdepth 3 -name ".git" -type d 2>/dev/null)
    fi
done

[ $found -eq 0 ] && out "_No commits found_"
out ""

end_time=$(($(date +%s%N)/1000000))
echo -e " \033[90m$((end_time - start_time))ms\033[0m" >&2

#######################################
# Window Activity
#######################################
echo -n "Processing window activity..." >&2
start_time=$(($(date +%s%N)/1000000))

out "### From Window Activity"
out ""

WINDOW_LOG="$LOG_DIR/windows-$DATE.log"
if [ -f "$WINDOW_LOG" ]; then
    awk -F'|' '{
        app = $2
        title = $3
        if (title !~ /^(New Tab|Untitled|$)/) {
            key = app "|" title
            if (!seen[key]++) {
                count[key]++
                apps[key] = app
                titles[key] = title
            } else {
                count[key]++
            }
        }
    }
    END {
        for (key in count) {
            if (count[key] >= 2) {
                print "- [window:" apps[key] "] " substr(titles[key], 1, 80)
            }
        }
    }' "$WINDOW_LOG" | sort -u | head -20 | while IFS= read -r line; do
        out "$line"
    done
else
    out "_No window log found for $DATE_"
fi
out ""

end_time=$(($(date +%s%N)/1000000))
echo -e " \033[90m$((end_time - start_time))ms\033[0m" >&2

#######################################
# Terminal Commands
#######################################
echo -n "Processing terminal history..." >&2
start_time=$(($(date +%s%N)/1000000))

out "### From Terminal"
out ""

if [ -f "$HOME/.zsh_history" ]; then
    start_ts=$(date -d "$DATE 00:00" +%s 2>/dev/null)
    end_ts=$(date -d "$DATE 23:59" +%s 2>/dev/null)

    # Use awk for faster processing instead of while loop
    awk -v start="$start_ts" -v end="$end_ts" -F':' '
    /^: [0-9]+:/ {
        ts = $2
        gsub(/^ /, "", ts)
        if (ts >= start && ts <= end) {
            cmd = $0
            sub(/^: [0-9]+:[0-9]+;/, "", cmd)
            if (cmd !~ /^(ls|cd|cat|less|head|tail|pwd|clear|exit|fg|bg|history|ll|la|\.\.|\.| )$/ &&
                cmd !~ /^(git status|git diff|git log|task |rofi)/) {
                cmds[cmd]++
            }
        }
    }
    END {
        for (cmd in cmds) {
            print cmds[cmd] "\t" cmd
        }
    }' "$HOME/.zsh_history" | sort -rn | head -15 | while IFS=$'\t' read -r count cmd; do
        out "- [terminal] $cmd"
    done
fi
out ""

end_time=$(($(date +%s%N)/1000000))
echo -e " \033[90m$((end_time - start_time))ms\033[0m" >&2

#######################################
# Browser History
#######################################
echo -n "Processing browser history..." >&2
start_time=$(($(date +%s%N)/1000000))

out "### From Browser"
out ""

CHROME_HISTORY="$HOME/.config/google-chrome/Default/History"
if [ -f "$CHROME_HISTORY" ]; then
    cp "$CHROME_HISTORY" /tmp/chrome_history_copy.db 2>/dev/null

    sqlite3 /tmp/chrome_history_copy.db "
        SELECT DISTINCT
            CASE
                WHEN url LIKE '%github.com%' THEN 'GitHub: ' || substr(url, instr(url, 'github.com/') + 11, 50)
                WHEN url LIKE '%stackoverflow.com%' THEN 'SO: ' || substr(title, 1, 60)
                WHEN url LIKE '%google.com/search%' THEN 'Search: ' || replace(substr(url, instr(url, 'q=') + 2, 40), '+', ' ')
                WHEN url LIKE '%youtube.com/watch%' THEN 'YT: ' || substr(title, 1, 50)
                WHEN url LIKE '%docs.%' OR url LIKE '%documentation%' THEN 'Docs: ' || substr(title, 1, 50)
                ELSE substr(title, 1, 60)
            END as desc
        FROM urls
        WHERE date(datetime(last_visit_time/1000000-11644473600, 'unixepoch', 'localtime')) = '$DATE'
        AND url NOT LIKE '%google.com/gen_%'
        AND url NOT LIKE '%chrome://%'
        AND url NOT LIKE '%newtab%'
        AND title != ''
        ORDER BY last_visit_time DESC
        LIMIT 25
    " 2>/dev/null | while IFS= read -r desc; do
        out "- [browser] $desc"
    done

    rm -f /tmp/chrome_history_copy.db
else
    out "_Chrome history not found_"
fi
out ""

end_time=$(($(date +%s%N)/1000000))
echo -e " \033[90m$((end_time - start_time))ms\033[0m" >&2

#######################################
# Claude Sessions
#######################################
echo -n "Processing Claude sessions..." >&2
start_time=$(($(date +%s%N)/1000000))

out "### From Claude Sessions"
out ""

CLAUDE_HISTORY="$HOME/.claude/history.jsonl"
if [ -f "$CLAUDE_HISTORY" ]; then
    start_ts=$(($(date -d "$DATE 00:00" +%s) * 1000))
    end_ts=$(($(date -d "$DATE 23:59" +%s) * 1000))

    jq -r --argjson start "$start_ts" --argjson end "$end_ts" '
        select(.timestamp >= $start and .timestamp <= $end) |
        "\(.project // "unknown")|\(.display)"
    ' "$CLAUDE_HISTORY" 2>/dev/null | \
    awk -F'|' '
    {
        proj = $1
        msg = $2
        n = split(proj, parts, "/")
        proj_name = parts[n]

        # Clean message
        gsub(/^ +| +$/, "", msg)

        # Skip noise: single chars, very short, or duplicate messages
        if (length(msg) > 15 && !seen[msg]++) {
            print "- [claude:" proj_name "] " substr(msg, 1, 80)
        }
    }' | head -20 | while IFS= read -r line; do
        out "$line"
    done
else
    out "_Claude history not found_"
fi
out ""

end_time=$(($(date +%s%N)/1000000))
echo -e " \033[90m$((end_time - start_time))ms\033[0m" >&2

#######################################
# Done
#######################################
echo "" >&2
echo -e "\033[32mSaved to: $OUTPUT_FILE\033[0m" >&2
