#!/bin/bash
# ~/.local/bin/task-menu

# Step 1: Select a task (all pending, sorted by urgency)
TASKS_JSON=$(task status:pending export)
MAX_PROJ=$(echo "$TASKS_JSON" | jq -r '[.[] | (.project // "-") | length] | max // 0')
PAD_WIDTH=$((MAX_PROJ + 3))

# Sort tasks and get index for lookup
SORTED_JSON=$(echo "$TASKS_JSON" | jq 'sort_by(-.urgency)')

SELECTED_IDX=$(echo "$SORTED_JSON" | \
  jq -r --argjson pad "$PAD_WIDTH" '.[] |
    (if (.tags // [] | contains(["recurrent"])) then "media-playlist-repeat" elif .priority == "H" then "emblem-important" elif .priority == "M" then "dialog-information" elif .priority == "L" then "dialog-question" else "dialog-apply" end) as $icon |
    (.project // "-") as $proj | ($proj + " " * ($pad - ($proj | length))) as $projpad |
    " \($projpad)\(.description[0:60])\u0000icon\u001f\($icon)"' | \
  rofi -dmenu -p "Tasks" -i -format 'i' -lines 15 -show-icons)

LOG="/tmp/task-menu-debug.log"
echo "=== $(date) ===" >> "$LOG"
echo "SELECTED_IDX: '$SELECTED_IDX'" >> "$LOG"

if [ -z "$SELECTED_IDX" ] || [ "$SELECTED_IDX" = "-1" ]; then
    echo "No selection, exiting" >> "$LOG"
    exit 0
fi

# Extract UUID and description from JSON by index
UUID=$(echo "$SORTED_JSON" | jq -r ".[$SELECTED_IDX].uuid")
DESC=$(echo "$SORTED_JSON" | jq -r ".[$SELECTED_IDX].description[0:60]")

echo "UUID: '$UUID'" >> "$LOG"
echo "DESC: '$DESC'" >> "$LOG"

# Check if task is currently active and has today tag
TASK_DATA=$(task $UUID export | jq -r '.[0]')
IS_ACTIVE=$(echo "$TASK_DATA" | jq -r '.start // empty')
HAS_TODAY=$(echo "$TASK_DATA" | jq -r 'if (.tags // [] | contains(["today"])) then "yes" else "" end')

# Build action menu based on state
ACTIONS="Done\0icon\x1fdialog-ok\n"
if [ -n "$IS_ACTIVE" ]; then
    ACTIONS+="Stop\0icon\x1fmedia-playback-pause\n"
else
    ACTIONS+="Start\0icon\x1fmedia-playback-start\n"
fi
if [ -n "$HAS_TODAY" ]; then
    ACTIONS+="Undo Today\0icon\x1fedit-undo\n"
else
    ACTIONS+="Today\0icon\x1fx-office-calendar\n"
fi
ACTIONS+="Tomorrow\0icon\x1fmedia-skip-forward\n"
ACTIONS+="Next Week\0icon\x1fx-office-calendar\n"
ACTIONS+="Park\0icon\x1fmedia-playback-stop"

# Step 2: Choose action
ACTION=$(echo -e "$ACTIONS" | rofi -dmenu -p "$DESC" -i -show-icons)

echo "ACTION: '$ACTION'" >> "$LOG"

case "$ACTION" in
    "Done")
        echo "Running: task $UUID done" >> "$LOG"
        task $UUID done >> "$LOG" 2>&1
        echo "Exit code: $?" >> "$LOG"
        notify-send "‚úì Task Completed" "$DESC"
        ;;
    "Start")
        # Stop all other active tasks first
        task +ACTIVE stop
        task $UUID start
        notify-send "‚ñ∂ Task Started" "$DESC"
        ;;
    "Stop")
        task $UUID stop
        notify-send "‚è∏ Task Stopped" "$DESC"
        ;;
    "Today")
        task $UUID modify +today scheduled:today
        notify-send "üìÖ Scheduled for Today" "$DESC"
        ;;
    "Undo Today")
        task $UUID modify -today scheduled:
        notify-send "‚ùå Removed from Today" "$DESC"
        ;;
    "Tomorrow")
        task $UUID modify scheduled:tomorrow
        notify-send "‚è≠ Scheduled for Tomorrow" "$DESC"
        ;;
    "Next Week")
        task $UUID modify scheduled:today+1week
        notify-send "üìÜ Postponed by a Week" "$DESC"
        ;;
    "Park")
        task $UUID modify wait:someday -today scheduled:
        notify-send "üÖøÔ∏è Parked" "$DESC"
        ;;
esac
