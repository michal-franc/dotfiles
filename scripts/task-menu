#!/bin/bash
# ~/.local/bin/task-menu

# Step 1: Select a task (all pending, sorted by urgency)
TASKS_JSON=$(task status:pending export)
MAX_PROJ=$(echo "$TASKS_JSON" | jq -r '[.[] | (.project // "-") | length] | max // 0')
PAD_WIDTH=$((MAX_PROJ + 3))

# Sort tasks and get index for lookup
SORTED_JSON=$(echo "$TASKS_JSON" | jq 'sort_by(-.urgency)')

# Get indices of today tasks for highlighting (offset by 1 for the special entry)
TODAY_INDICES=$(echo "$SORTED_JSON" | jq -r 'to_entries | .[] | select(.value.tags // [] | contains(["today"])) | (.key + 1)' | paste -sd,)

ROFI_ARGS="-dmenu -p Tasks -i -format i -lines 15 -show-icons"
[ -n "$TODAY_INDICES" ] && ROFI_ARGS="$ROFI_ARGS -a $TODAY_INDICES"

# Add special "Record Done Task" entry at the top (index 0)
SPECIAL_ENTRY=" + Record Done Task\0icon\x1fdialog-ok-apply"
TASK_ENTRIES=$(echo "$SORTED_JSON" | \
  jq -r --argjson pad "$PAD_WIDTH" '.[] |
    (if (.tags // [] | contains(["recurrent"])) then "media-playlist-repeat" elif .priority == "H" then "emblem-important" elif .priority == "M" then "dialog-information" elif .priority == "L" then "dialog-question" else "dialog-apply" end) as $icon |
    (.project // "-") as $proj | ($proj + " " * ($pad - ($proj | length))) as $projpad |
    " \($projpad)\(.description[0:60])\u0000icon\u001f\($icon)"')

SELECTED_IDX=$(echo -e "$SPECIAL_ENTRY\n$TASK_ENTRIES" | rofi $ROFI_ARGS)

LOG="/tmp/task-menu-debug.log"
echo "=== $(date) ===" >> "$LOG"
echo "SELECTED_IDX: '$SELECTED_IDX'" >> "$LOG"

if [ -z "$SELECTED_IDX" ] || [ "$SELECTED_IDX" = "-1" ]; then
    echo "No selection, exiting" >> "$LOG"
    exit 0
fi

# Handle special "Record Done Task" entry (index 0)
if [ "$SELECTED_IDX" = "0" ]; then
    echo "Record Done Task selected" >> "$LOG"

    # Step 1: Get task description
    DONE_DESC=$(rofi -dmenu -p "Done task description:" -lines 0)
    if [ -z "$DONE_DESC" ]; then
        echo "No description entered, exiting" >> "$LOG"
        exit 0
    fi

    # Step 2: Get list of projects and let user select
    PROJECTS=$(task _unique project | grep -v '^$' | sort)
    PROJECT_LIST="(No Project)\0icon\x1fdialog-cancel"
    while IFS= read -r proj; do
        [ -n "$proj" ] && PROJECT_LIST+="\n$proj\0icon\x1ffolder"
    done <<< "$PROJECTS"

    SELECTED_PROJECT=$(echo -e "$PROJECT_LIST" | rofi -dmenu -p "Select project:" -i -show-icons)

    if [ -z "$SELECTED_PROJECT" ]; then
        echo "No project selected, exiting" >> "$LOG"
        exit 0
    fi

    # Step 3: Create task and mark as done
    if [ "$SELECTED_PROJECT" = "(No Project)" ]; then
        echo "Creating task without project: $DONE_DESC" >> "$LOG"
        task add "$DONE_DESC"
    else
        echo "Creating task with project $SELECTED_PROJECT: $DONE_DESC" >> "$LOG"
        task add project:"$SELECTED_PROJECT" "$DONE_DESC"
    fi

    # Get the UUID of the just-created task and mark it done
    NEW_UUID=$(task +LATEST uuids)
    task $NEW_UUID done >> "$LOG" 2>&1

    notify-send "‚úì Recorded Done Task" "$DONE_DESC"
    exit 0
fi

# Adjust index for actual tasks (offset by 1 due to special entry)
TASK_IDX=$((SELECTED_IDX - 1))

# Extract UUID and description from JSON by index
UUID=$(echo "$SORTED_JSON" | jq -r ".[$TASK_IDX].uuid")
DESC=$(echo "$SORTED_JSON" | jq -r ".[$TASK_IDX].description[0:60]")

echo "UUID: '$UUID'" >> "$LOG"
echo "DESC: '$DESC'" >> "$LOG"

# Check if task is currently active and has today tag
TASK_DATA=$(task $UUID export | jq -r '.[0]')
IS_ACTIVE=$(echo "$TASK_DATA" | jq -r '.start // empty')
HAS_TODAY=$(echo "$TASK_DATA" | jq -r 'if (.tags // [] | contains(["today"])) then "yes" else "" end')

# Build action menu based on state
ACTIONS="Done\0icon\x1fdialog-ok\n"
if [ -n "$IS_ACTIVE" ]; then
    ACTIONS+="Stop\0icon\x1fmedia-playback-pause\n"
else
    ACTIONS+="Start\0icon\x1fmedia-playback-start\n"
fi
if [ -n "$HAS_TODAY" ]; then
    ACTIONS+="Undo Today\0icon\x1fedit-undo\n"
else
    ACTIONS+="Today\0icon\x1fx-office-calendar\n"
fi
ACTIONS+="Tomorrow\0icon\x1fmedia-skip-forward\n"
ACTIONS+="Next Week\0icon\x1fx-office-calendar\n"
ACTIONS+="Park\0icon\x1fmedia-playback-stop\n"
ACTIONS+="Edit\0icon\x1faccessories-text-editor\n"
ACTIONS+="Delete\0icon\x1fedit-delete"

# Step 2: Choose action
ACTION=$(echo -e "$ACTIONS" | rofi -dmenu -p "$DESC" -i -show-icons)

echo "ACTION: '$ACTION'" >> "$LOG"

case "$ACTION" in
    "Done")
        echo "Running: task $UUID done" >> "$LOG"
        task $UUID done >> "$LOG" 2>&1
        echo "Exit code: $?" >> "$LOG"
        notify-send "‚úì Task Completed" "$DESC"
        ;;
    "Start")
        # Stop all other active tasks first
        task +ACTIVE stop
        task $UUID start
        notify-send "‚ñ∂ Task Started" "$DESC"
        ;;
    "Stop")
        task $UUID stop
        notify-send "‚è∏ Task Stopped" "$DESC"
        ;;
    "Today")
        task $UUID modify +today scheduled:today
        notify-send "üìÖ Scheduled for Today" "$DESC"
        ;;
    "Undo Today")
        task $UUID modify -today scheduled:
        notify-send "‚ùå Removed from Today" "$DESC"
        ;;
    "Tomorrow")
        task $UUID modify scheduled:tomorrow
        notify-send "‚è≠ Scheduled for Tomorrow" "$DESC"
        ;;
    "Next Week")
        task $UUID modify scheduled:today+1week
        notify-send "üìÜ Postponed by a Week" "$DESC"
        ;;
    "Park")
        DAYS_MENU="1 day\0icon\x1fmedia-skip-forward
2 days\0icon\x1fmedia-skip-forward
3 days\0icon\x1fmedia-skip-forward
5 days\0icon\x1fmedia-skip-forward
1 week\0icon\x1fx-office-calendar
2 weeks\0icon\x1fx-office-calendar
1 month\0icon\x1fx-office-calendar
Someday\0icon\x1fmedia-playback-stop"
        PARK_SELECTION=$(echo -e "$DAYS_MENU" | rofi -dmenu -p "Park for how long?" -i -show-icons)
        case "$PARK_SELECTION" in
            "1 day") task $UUID modify wait:today+1day -today scheduled: && notify-send "Parked 1 day" "$DESC" ;;
            "2 days") task $UUID modify wait:today+2days -today scheduled: && notify-send "Parked 2 days" "$DESC" ;;
            "3 days") task $UUID modify wait:today+3days -today scheduled: && notify-send "Parked 3 days" "$DESC" ;;
            "5 days") task $UUID modify wait:today+5days -today scheduled: && notify-send "Parked 5 days" "$DESC" ;;
            "1 week") task $UUID modify wait:today+1week -today scheduled: && notify-send "Parked 1 week" "$DESC" ;;
            "2 weeks") task $UUID modify wait:today+2weeks -today scheduled: && notify-send "Parked 2 weeks" "$DESC" ;;
            "1 month") task $UUID modify wait:today+1month -today scheduled: && notify-send "Parked 1 month" "$DESC" ;;
            "Someday") task $UUID modify wait:someday -today scheduled: && notify-send "Parked indefinitely" "$DESC" ;;
        esac
        ;;
    "Edit")
        NEW_DESC=$(rofi -dmenu -p "Edit description:" -lines 0 -filter "$DESC")
        if [ -n "$NEW_DESC" ] && [ "$NEW_DESC" != "$DESC" ]; then
            task $UUID modify description:"$NEW_DESC"
            notify-send "‚úèÔ∏è Task Updated" "$NEW_DESC"
        fi
        ;;
    "Delete")
        task rc.confirmation=off $UUID delete
        notify-send "Deleted" "$DESC"
        ;;
esac
